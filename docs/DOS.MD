# OS/90 DOS+DPMI Compliance Strategy

OS/90 is DPMI-compatible and supports most 1.0 features (with some exceptions). It reports 0.9 unless configured otherwise. it also is capable of simulating 16-bit DOS.

# DOS Virtual Machines

## Program Segment Prefix

The PSP has many components that must function as expected.

### Environment Segment

The environment will usually be initialized by the command interpreter. It is nothing more than a region of memory, which in our case is isolated for each VM, that contains string data set up by `AUTOEXEC.BAT`. Changes to the environment require restarting the command interpreter.

In cases where a program is executed without COMMAND.COM starting it up, ENV will be empty and preallocated to the size explicitly requested.

### Job File Table

The JFT is a list of indices into the System File Table. It represents every handle opened by the currently executing program and is a part of the local context.
An entry in thhe JFT

The JFT's first entries are:
- stdin (0)
- stdout (1)
- stderr (2)
- com1 (3)
- lpt (4)
- Rest are FF

The actual SFT is still used for 16-bit FS capability.

The JFT is 20 entries as usual and that is the size reported in the PSP.

### Critical, ^C, and Exit Addresses

These are techically old features that should not be relied upon.

### File Control Blocks

OS/90 does not support file control blocks. This is fine since Windows 95 also does not support them.


### Disk Transfer Area

A DTA is provided by default and the internal DTA address is set to this location.

### Call 5

This interface is supported. Some programs depend on it. Call 5 simply calls INT 21H.

### Command Line

Automatically generated by executing program.

### Internal Parent PSP Segment

DOS esentially executes programs like a stack. This is the PSP of the task that executed the current one.

### Segment of First Byte

Segments

## Handling of Subprograms

The interface for creating subprograms is controlled by the OS and the entire executable loader is reimplemented in the kernel.

Subprograms get complicated when DPMI is involved. The specification is not very specific, but I have been able to run DJGPP from a command prompt spawned by RHIDE. This indicates that nested instances of DOS programs does work, and they CAN in fact enter protected mode on their own.

A new task is created for subprograms, but the invoking program.

> What if we _don't_ block the process that spawned a new one? It could work, but the return code is impossible to deduce. There is no way a compiler toolchain could handle this.

## Memory Management

OS/90 uses a single address space for DOS. The conventional memory is unpagable and therefore limited in all situations to 640K. This can be a problem for some demanding games that could need up to 500K in order to run properly.

The memory manager of DOS is used. Best fit allocation strategy is used.

### XMS Emulation

Each VM gets a certain number of XMS handles which are non-sharable between VMs. A simple lookup table with 24-bit compressed chain IDs is used.

### EMS Emulation

OS/90 cannot tolerate the exisitence of EMM386 or anything similar and implements its own EMS simulator.

## Context In General

OS/90 uses scheduler tasks to run DOS virtual machine. The distiction is that tasks can belong to a VM as threads of execution, while VMs are simply "instances" of the partially-simulated operating system.

The VM context contains:
```
Full PSP
Local Ctrl-C and critical error handlers
Local system idle loop handler
Local interrupt vector table

Current drive
Current path

Conventional memory context
LIMulation context
Virtual text mode framebuffer
INT 21h STDIO callbacks
DTA address

Pointer to first child VM

Flag for "do subprograms run seperately?"

```
